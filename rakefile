#
# Timber build script.
#


SOURCE_DIR = 'src'
BUILD_DIR = 'build'
EXAMPLE_DIR = 'examples'

TEST_SOURCE_DIR = 'tests/src'
TEST_BUILD_DIR = 'tests/build'


#
# Common functions.
#

def macos?
    RUBY_PLATFORM.downcase.include? 'darwin'
end

# Open the given file with it's default program.
def open(file)
    cmd = macos? ? "open" : "gnome-open" # supports macos and gnome
    sh("#{cmd} #{file}")
end


# Compile the given coffeescript files.
def compile(source_dir, build_dir, watch=false)
  opts = (watch) ? '--watch' : ''
  sh("coffee #{opts} -o #{build_dir} -c #{source_dir}")
end


#
# Compilation tasks.
#

namespace "compile" do

  def compile_timber(watch=false)
    compile(SOURCE_DIR, BUILD_DIR, watch)
  end

  desc "Compile when source files change."
  task "watch" do
    compile_timber(true)
  end

  task "compile" do
    compile_timber()
  end

end

desc "Compile source files."
task "compile" => ["compile:compile"]

#
# Testing tasks
#

namespace "test" do

  def compile_tests(watch=false)
    compile(TEST_SOURCE_DIR, TEST_BUILD_DIR, watch)
  end

  desc "Compile tests when source changes."
  task "compile" do
    compile_tests()
  end

  desc "Compile tests when source changes."
  task "compile:watch" do
    compile_tests(true)
  end

  task "browser" => ["compile"] do
    open("tests/tests.html")
  end

end

desc "Run tests in a browser."
task "test" => ["test:browser"]

#
# Example tasks.
#

desc "Run the example programs."
task "examples" => "compile" do
    Dir.glob("#{EXAMPLE_DIR}/*.html").each do |example|
        open(example)
    end
end
