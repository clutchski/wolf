#
# Timber build script.
#

require 'sprockets'


SOURCE_DIR = 'src'
BUILD_DIR = 'build'

TEST_SOURCE_DIR = 'tests/src'
TEST_BUILD_DIR = 'tests/build'

#
# Compilation tasks.
#


def compile(source_dir, build_dir, watch=false)
  opts = (watch) ? '--watch' : ''
  sh("coffee #{opts} -o #{build_dir} -c #{source_dir}")
end

namespace "compile" do

  def compile_timber(watch=false)
    compile(SOURCE_DIR, BUILD_DIR, watch)
  end

  desc "Compile when source files change."
  task "watch" do
    compile_timber(true)
  end
task "compile" do
    compile_timber()
  end

end

desc "Compile source files."
task "compile" => ["compile:compile"]

#
# Testing tasks
#

namespace "test" do

  def compile_tests(watch=false)
    compile(TEST_SOURCE_DIR, TEST_BUILD_DIR, watch)
  end

  desc "Compile tests when source changes."
  task "compile" do
    compile_tests()
  end

  desc "Compile tests when source changes."
  task "compile:watch" do
    compile_tests(true)
  end

  task "browser" => ["compile"] do
    open = "gnome-open" #FIXME: add open for macosx
    sh("#{open} tests/tests.html")
  end

end

desc "Run tests in a browser."
task "test" => ["test:browser"]
